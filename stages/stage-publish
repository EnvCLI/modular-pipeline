#!/usr/bin/env bash
set -euo pipefail
STAGE_NAME="publish"

# common
LOCAL_PATH=${BASH_SOURCE%/*}
source "$LOCAL_PATH/pipeline-common"

# main
function main()
{
  # container
  if test -f "dist/container-image/main.tar"; then
    # import image
    act-log-message "publishing container image from dist/container-image/main.tar" "INFO"
    docker load -i dist/container-image/main.tar

    # publish
    action-container-push
  fi

  # bintray
  if [[ ${DEPLOYMENT_TYPE} == "bintray" ]]; then
    # for cli and libraries, TODO: add filter later
    act-log-message "publishing bintray artifacts from dist/" "INFO"
    action-bintray-publish
  fi
}

# entrypoint
case "${1:-}" in
  help)
    echo "Stage - Publish"
    echo "Will publish artifacts"
    echo ""
    echo "Environment:"
    echo "* DEBUG: Can be set to true to enable debugging"
    ;;
  *)
    _log_message "Running action [$STAGE_NAME]" "INFO"
    _prepare
    _run_hook "pre-$STAGE_NAME"
    main "$@"
    _run_hook "post-$STAGE_NAME"
;;
esac
